# Kolacik Session Log

## 2026-01-08 - Initial Setup

### What We Did
- Forked Strudel from codeberg.org/uzu/strudel
- Created kolacik theme (near-black background, Operator Mono font, orange keywords, teal strings)
- Built live sync system: Claude can push code to browser via playground.strudel
- Started learning Strudel basics

### Live Sync Architecture
- `sync-server.mjs` - WebSocket server on port 4322, watches playground.strudel
- `website/src/repl/sync.mjs` - client that connects and syncs with editor
- Modified `useReplContext.jsx` to hook into sync

### Files Created
- `playground.strudel` - live code scratchpad
- `sync-server.mjs` - sync server
- `claude.md` - teaching instructions
- `what_jura_knows.md` - knowledge state
- `plan.md` - learning plan
- `packages/codemirror/themes/kolacik.mjs` - custom theme

### Jura's Progress
- Learned: euclidean rhythms, polymetric, struct, off vs delay, wet/dry
- Next: scales, notes, .add(), more pattern modifiers

### To Start Dev
```bash
pnpm dev
node sync-server.mjs &
# open localhost:4321
```

## 2026-01-08 - Session 2: Quiz & Error Feedback

### What We Did
- Ran quiz to assess Jura's knowledge - he knows more than documented
- Built bidirectional error sync system:
  - `playground.errors` - warnings/errors written here so Claude can see them
  - Toast notifications in UI (bottom-right, orange)
  - Modified `useLogger.jsx` to forward warnings to sync server
  - Modified `sync-server.mjs` to write errors to file
  - Modified `value.mjs` to give helpful error message for `.add()` gotcha

### Key Technical Findings
- `.add(12)` silently fails - must use `.add(note(12))`
- Can't mix samples and notes in same `note()` pattern - use `stack()` or separate `$:` lines
- Out-of-range notes (like `c90`) fail silently - TODO: add warning
- HMR doesn't always reload core package changes - need hard refresh
- `useLogger` hook was only active when Panel was open - moved to Repl.jsx

### Files Modified
- `sync-server.mjs` - added error message handling
- `website/src/repl/sync.mjs` - added `sendError()` function
- `website/src/repl/components/useLogger.jsx` - forward warnings to sync + toast
- `website/src/repl/Repl.jsx` - added Toast component, call useLogger always
- `packages/core/value.mjs` - improved warning message with fix hint

### Files Created
- `playground.errors` - error sync file

### Next Session
- Continue learning: scales, chords, more effects
- Add validation for out-of-range notes

## 2026-01-08 - Session 3: Music Theory & Song Building

### What We Did
- Fixed error feedback system (was only catching warnings, not errors)
- Taught music theory from scratch:
  - Key = home note + major/minor
  - Home = resolution point (demonstrated with sound)
  - Scale = 7 notes that belong, accessed via `.scale()` and `n("0 1 2...")`
  - Chords = stack every other note (0,2,4)
  - Progressions = sequence of chords, tension → release
  - Melody = contour + rhythm + repetition
- Built a full 4-layer song together (drums, bass, chords, melody)
- Jura evolved it with nested alternation, GM samples, filter modulation

### Key Technical Findings
- Error sync was broken because superdough's `errorLogger` passes message without type
- `useLogger.jsx` only checked for `[warn]` in message, not `error:`
- Fix: check for both `[warn]` and `error:` in message string

### Files Modified
- `website/src/repl/components/useLogger.jsx` - detect errors by checking for `error:` in message

### Teaching Insights
- ONE CONCEPT AT A TIME - Jura explicitly said "one thing at a time man" when I dumped too much
- Demonstrate with SOUND before explaining with words
- Let him experiment between explanations
- Use analogies to his domain (dynamical systems, equilibrium, signal processing)
- Guitar chord question was great bridge - physical intuition → abstract concept

### Example Track Created
```javascript
// DRUMS (split kick for layered sound)
$: s("~ ~ bd ~, ~ hh*2 ~ hh*2, ~ ~ sd ~").gain(.8).lpf(1200)
$: s("bd ~ ~ ~").gain(1.3).lpf(800).room(0.3).echo(3,1,0.3)

// BASS
$: n("<0 3 4 0>").scale("C:minor").sub(note(12)).s("gm_synth_bass_1").lpf(400).gain(.6)

// CHORDS
$: n("<[0,2,4] [3,5,7] <[4,6,8] [[2,4,6] [4, 6, 8]]> [0,2,4]>").scale("C:minor").s("gm_synth_strings_1").lpf(800).gain(.3)

// MELODY
$: n("[0 2 4 ~ 0 2 5 ~ 0 2 4 ~ 3 2 0 ~]/4").scale("C:minor").add(note(12)).s("gm_electric_guitar_muted:5").gain(.8).sustain(2).lpf("<900 1600>")
```

### Next Session
- More effects/texture
- Sample manipulation
- Chromatic notes (outside the scale)
- Maybe: LFO modulation with `sine.range().slow()`

## 2026-01-09 - Session 4: Harmony Deep Dive & Arrangement

### What We Did
- Reviewed Jura's first independent composition attempt
- Taught roman numeral notation: i, ii, iii, iv, v, vi = chords on scale degrees 0-5
- Explained strong vs weak chords:
  - Strong: i (home), iv, v (clear tension/resolution)
  - Weak: ii, iii (share notes with i, less contrast)
- Tension/resolution in endings:
  - ii° = cliffhanger (diminished, unstable)
  - vi = soft landing (related but not home)
  - i = full resolution
- Fixed slider arithmetic: `slider()` returns Pattern, use `.add()` not `+`
- Built mixer-style arrangement with per-layer volume sliders
- Added visualizations: `._pianoroll()` for pitched, `._punchcard()` for drums
- Used `.every()` for melodic variation

### Key Technical Findings
- `slider() + 200` fails with "non-finite" error - slider returns Pattern
- Fix: use `slider().add(200)` for pattern math
- Orbits are for effects routing, not per-pattern values

### Example Track Created
```javascript
setcpm(220/4)
const lpf_base = slider(600, 600, 2000, 1)

const melody = slider(0.6,0,1,0.1)
const bass = slider(0.5,0,1,0.1)
const chords = slider(0.5,0,1,0.1)
const drums = slider(0.9,0,1,0.1)
const boom = slider(1,0,1,0.1)

// CHORDS: i → iv → v → ii°/i(high)
$: note("[[0, 2, 4] [3, 5, 7] [4, 6, 8] <[1, 3, 5] [7, 9, 11]>]/2")
  .scale("d:minor").lpf(lpf_base.add(200)).room(0.4)
  .sound("sawtooth").gain(chords)

// BASS: follows chord roots
$: note("[0 3 4 <1 7>]/2").scale("d:minor")
  .sound("triangle").lpf(lpf_base.add(600)).gain(bass)

// DRUMS: split kick pattern
$: s("~ ~ bd <sd [sd, [sd sd]]> ~ sd").bank("bossdr110").gain(drums)
$: s("bd ~ ~ ~ ~").bank("bossdr110").room(0.5).gain(boom).delay(0.2)

// MELODY: arpeggio with .every() variation
$: note("[0, 2, 4] [3, 5, 7] [4, 6, 8] <[1, 3, 5] [7, 9, 11]>")
  .every(4, x => x.add(note(7))).every(3, x => x.add(note(-7)))
  .scale("d:minor").arp("0 1 2 <0 1>").add(note(12)).slow(2)
  .sound("gm_music_box").gain(melody)
```

### Jura's Progress
- Can now build complete arrangements independently
- Understands chord function (strong/weak, tension/resolution)
- Using sliders for live mixing
- Experimenting with `.every()` for variation

### Next Session
- B sections / contrasting parts
- More effects
- Maybe: recording/exporting

## 2026-02-08 - Session 6: Multi-Track Mixer Interface

### What We Did
- Built a completely new interface: multi-track mixer at `/mixer`
- Each track lives in its own file (`tracks/*.strudel`)
- Sync server compiles all tracks into a single strudel document in realtime
- Full mute/solo/delete per track, global effects editor, BPM control
- Play-once mode (plays 1 cycle then stops)
- WebSocket protocol extended for Claude to control everything from CLI

### Architecture
- `website/src/pages/mixer.astro` — Astro page
- `website/src/repl/Mixer.jsx` — React component with multiple CodeMirror editors + hidden master StrudelMirror for audio
- `website/src/repl/mixer-sync.mjs` — browser-side WebSocket client for mixer protocol
- `sync-server.mjs` — extended with track file watching, compiler, mixer state management
- `tracks/` — directory of individual `.strudel` files
- `mix.json` — mixer state (mute/solo/bpm/globalFx)
- `mix.strudel` — compiled output (auto-generated)

### Compiler
Simple string concatenation: reads all track files, skips muted/non-soloed, appends global FX. Writes to `mix.strudel` and pushes via WebSocket. The `$:` patterns from each track naturally stack when evaluated by the single master repl.

### Claude Control Interface
- Write to `tracks/{name}.strudel` → auto-compiles and pushes
- Edit `mix.json` → mute/solo/bpm changes propagate
- `playground.cmd` → play/stop/toggle/play-once commands
- WebSocket messages: `mixer:track`, `mixer:track:add`, `mixer:track:remove`, `mixer:state`

### Technical Findings
- macOS `fs.watch` fires double events and `rename` for modifications — needed debounce (100ms per file) and explicit `stat()` check before assuming deletion
- Earlier version had a race condition where `fs.watch` catch block would delete tracks from memory on transient read failures
- `StrudelMirror` needs a real DOM element (not `display:none`) — used `overflow-hidden h-0` for the hidden master

### Files Created
- `website/src/pages/mixer.astro`
- `website/src/repl/Mixer.jsx`
- `website/src/repl/mixer-sync.mjs`

### Files Modified
- `sync-server.mjs` — major extension with mixer protocol
- `.gitignore` — added tracks/, mix.strudel, mix.json

### Starter Tracks Created
10 tracks all in D minor: kick, snare, hats, clap, perc, bass, chords, pad, melody, arp

### Next Steps
- ~~Visualization per track (pianoroll/punchcard)~~ ✓
- Track renaming in UI
- Drag to reorder tracks
- Record/export compiled output
- Sample loading UI

## 2026-02-08 - Session 7: Visualization, Highlighting & Artifacts

### What We Did
- **Per-track visualization + highlighting**: Replaced `initEditor` with full `StrudelMirror` per track
  - Silent output (`defaultOutput: async () => {}`) — per-track repls evaluate patterns but produce no audio
  - Mini-notation highlighting animates automatically via StrudelMirror's Drawer
  - Per-track canvas positioned behind editor (absolute + z-index layering)
  - `editPattern` callback injects visualization painters based on dropdown selection
  - Per-track repls start/stop in sync with master via `started` prop
  - Code changes debounced at 500ms, re-evaluate for live updating visualization
- **5 visualization types**: pianoroll, punchcard, wordfall (vertical+labels), smear (trail effect), active-only
- **Mouse-reactive LPF**: Global FX uses `mousex.range(200, 8000)` — Strudel has built-in `mouseX`/`mouseY` signals (0-1 range from mouse position)
- **Track groups** (from earlier): Number keys 0-9 toggle mute for grouped tracks
- **Mute all button**
- **Artifact system** for multi-track pieces:
  - Format: directory with `tracks/*.strudel` + `mix.json`
  - `save-piece.sh <name>` and `load-piece.sh <name>` scripts
  - First multi-track artifact: `05-d-minor-multitrack` (11 tracks, D minor)
  - `artifacts/README.md` documents the format

### Key Technical Findings
- `StrudelMirror` overrides font size to its default (18px) — must call `mirror.setFontSize(14)` after construction
- `.cm-scroller` needs explicit `maxHeight` + `overflow: auto` to constrain CodeMirror height within a panel
- `Object.defineProperty` on `mirror.code` cleanly intercepts StrudelMirror's internal code changes without modifying the library
- `.gitignore` `tracks/` matches ANY `tracks/` dir (including inside artifacts) — fixed to `/tracks/` (root only)
- `getPunchcardPainter({ fold: 0 })` = pianoroll as a Drawer-pipeline painter (unlike `.pianoroll()` which has its own animation loop)
- Strudel's `mousex`/`mousey` are already built-in signals in `@strudel/core/signal.mjs` — no custom code needed

### Files Modified
- `website/src/repl/Mixer.jsx` — major rewrite of TrackPanel (initEditor → StrudelMirror), viz types, mouse LPF
- `.gitignore` — `/tracks/` instead of `tracks/` to allow artifact subdirs

### Files Created
- `artifacts/05-d-minor-multitrack/` — first multi-track artifact (11 tracks + mix.json)
- `artifacts/README.md` — artifact format documentation
- `save-piece.sh` — save current mixer state as named artifact
- `load-piece.sh` — load saved artifact into mixer

### Next Steps
- Track renaming in UI
- Drag to reorder tracks
- Record/export compiled output
- Sample loading UI
- Per-track volume/gain control
